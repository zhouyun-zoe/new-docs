<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="generator" content="Docusaurus v2.0.0-alpha.54">
<link rel="alternate" type="application/rss+xml" href="/new-docs/blog/rss.xml" title="Muta Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/new-docs/blog/atom.xml" title="Muta Blog Atom Feed">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu|Roboto|Source+Code+Pro">
<link rel="stylesheet" href="https://at-ui.github.io/feather-font/css/iconfont.css">

<title data-react-helmet="true">Mempool | Docs | Muta</title>

<meta data-react-helmet="true" property="og:title" content="Muta"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="description" content="## 设计要求"><meta data-react-helmet="true" property="og:description" content="## 设计要求"><meta data-react-helmet="true" property="og:url" content="https://zhouyun-zoe.github.io/new-docs/docs/docs_zh/advanced/core/mempool">

<link data-react-helmet="true" rel="shortcut icon" href="/new-docs/img/muta-logo.png">


<link rel="stylesheet" href="/new-docs/styles.1106e972.css">


<link rel="preload" href="/new-docs/styles.a0bcde56.js" as="script">

<link rel="preload" href="/new-docs/runtime~main.c72716e7.js" as="script">

<link rel="preload" href="/new-docs/main.ed56201c.js" as="script">

<link rel="preload" href="/new-docs/1.e4da9918.js" as="script">

<link rel="preload" href="/new-docs/2.b26b4069.js" as="script">

<link rel="preload" href="/new-docs/3.045d625b.js" as="script">

<link rel="preload" href="/new-docs/1be78505.5b0e4c14.js" as="script">

<link rel="preload" href="/new-docs/46ce4c7b.572e61af.js" as="script">

<link rel="preload" href="/new-docs/5.bc0d6714.js" as="script">

<link rel="preload" href="/new-docs/17896441.c7f410fa.js" as="script">

<link rel="preload" href="/new-docs/d8bb8ba4.f49ee4c4.js" as="script">

</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=window.matchMedia("(prefers-color-scheme: dark)"),n=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();null!==n?t(n):e.matches&&t("dark")}()</script>
<div id="__docusaurus">
<nav class="navbar navbar--light navbar--fixed-top navbarHideable_OaSq"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/new-docs/"><img class="navbar__logo" src="/new-docs/img/muta.svg" alt="muta"></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/new-docs/docs/">Docs</a><a class="navbar__item navbar__link" href="/new-docs/guides/">Guides</a><a class="navbar__item navbar__link" href="/new-docs/blog/">Blog</a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/new-docs/community/">Communtiy</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a activeclassname="navbar__link--active" class="navbar__item navbar__link">translate</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/new-docs/docs-zh/what-is-muta">中文</a></li><li><a class="dropdown__link" href="/new-docs/docs/about/what-is-muta">English</a></li></ul></div><a target="_blank" rel="noopener noreferrer" href="https://github.com/nervosnetwork/muta" class="navbar__item navbar__link header-github-link"></a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_1gtM"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_34Mc moon_313u"></span></div><div class="react-toggle-track-x"><span class="toggle_34Mc sun_1Og-"></span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Search" aria-label="Search" class="navbar__search-input search-bar"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/new-docs/"><img class="navbar__logo" src="/new-docs/img/muta.svg" alt="muta"></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" position="left" href="/new-docs/docs/">Docs</a></li><li class="menu__list-item"><a class="menu__link" position="left" href="/new-docs/guides/">Guides</a></li><li class="menu__list-item"><a class="menu__link" position="left" href="/new-docs/blog/">Blog</a></li><li class="menu__list-item"><a class="menu__link" position="right" href="/new-docs/community/">Communtiy</a></li><li class="menu__list-item"><a activeclassname="navbar__link--active" class="menu__link menu__link--sublist" position="right">translate</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/new-docs/docs-zh/what-is-muta">中文</a></li><li class="menu__list-item"><a class="menu__link" href="/new-docs/docs/about/what-is-muta">English</a></li></ul></li><li class="menu__list-item"><a target="_blank" rel="noopener noreferrer" href="https://github.com/nervosnetwork/muta" class="menu__link header-github-link" position="right"></a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="container_3Vzv container container--l"><div class="sidebar_dgnY"><div class="docs-sidebar sidebar_25T_"><a class="sidebarLogo_3JkW" href="/new-docs/"></a><div class="menu menu--responsive menu_1e9D"><button aria-label="Open Menu" class="button button--secondary button--sm menu__button" type="button"><svg class="sidebarMenuIcon_1hKf" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><div class="title">About</div><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/new-docs/docs/docs_zh/about/what-is-muta/">What is Muta?</a></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/new-docs/docs/docs_zh/about/concepts/">Basic Concepts</a></li></ul></li><li class="menu__list-item"><div class="title">Setup</div><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/new-docs/docs/docs_zh/setup/getting-started/">Getting Started</a></li><li class="menu__list-item menu__list-item--collapsed"><a activeclassname="menu__link--active" class="menu__link menu__link--sublist" href="/new-docs/docs/docs_zh/setup/config/">Configuration</a><ul class="menu__list"><li class="menu__list-item menu__list-item-hidden"><a class="menu__link" activeclassname="menu__link--active" href="/new-docs/docs/docs_zh/setup/config/">hidden</a></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/new-docs/docs/docs_zh/setup/genesis-config/">Genesis Configuration</a></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/new-docs/docs/docs_zh/setup/node-config/">Node Configuration</a></li></ul></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/new-docs/docs/docs_zh/setup/deploy/">Deployment</a></li></ul></li><li class="menu__list-item"><div class="title">Development</div><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/new-docs/docs/docs_zh/dev/dev-overview/">Overview</a></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/new-docs/docs/docs_zh/dev/service-dev/">Service Development Guide</a></li><li class="menu__list-item menu__list-item--collapsed"><a activeclassname="menu__link--active" class="menu__link menu__link--sublist" href="/new-docs/docs/docs_zh/service-list/service-overview/">Service  List</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/new-docs/docs/docs_zh/service-list/service-overview/">Overview</a></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/new-docs/docs/docs_zh/service-list/metadata-service/">Metadata Service</a></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/new-docs/docs/docs_zh/service-list/asset-service/">Asset Service</a></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/new-docs/docs/docs_zh/service-list/auth-service/">Authorization Service</a></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/new-docs/docs/docs_zh/service-list/multi-sig-service/">Multi-signature Service</a></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/new-docs/docs/docs_zh/service-list/gov-service/">Governance Service</a></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/new-docs/docs/docs_zh/service-list/riscv-service/">RISC-V Service</a></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/new-docs/docs/docs_zh/service-list/admission-service/">Admission Control Service</a></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/new-docs/docs/docs_zh/service-list/kyc-service/">KYC Service</a></li></ul></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/new-docs/docs/docs_zh/dev/poe-chain/">Develop a Service</a></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/new-docs/docs/docs_zh/dev/dex/">Develop a Dapp Chain</a></li></ul></li><li class="menu__list-item"><div class="title">Advanced</div><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/new-docs/docs/docs_zh/advanced/arch/">Architecture</a></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/new-docs/docs/docs_zh/advanced/core/overlord/">Overlord</a></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/new-docs/docs/docs_zh/advanced/core/network/">Network</a></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/new-docs/docs/docs_zh/advanced/core/mempool/">Mempool</a></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/new-docs/docs/docs_zh/advanced/core/storage/">Storage</a></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/new-docs/docs/docs_zh/advanced/crypto/">Cryptography</a></li></ul></li><li class="menu__list-item"><div class="title">Toolchain</div><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/new-docs/docs/docs_zh/toolchain/sdk-js/">JS SDK</a></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/new-docs/docs/docs_zh/toolchain/sdk-java/">JAVA SDK</a></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/new-docs/docs/docs_zh/toolchain/muta-cli/">Muta CLI</a></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/new-docs/docs/docs_zh/toolchain/explorer/">Muta Explorer</a></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/new-docs/docs/docs_zh/toolchain/benchmark-tool/">Muta Benchmark Tool</a></li><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/new-docs/docs/docs_zh/toolchain/keypair/">Keypair</a></li></ul></li><li class="menu__list-item"><div class="title">Reference</div><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" activeclassname="menu__link--active" href="/new-docs/docs/docs_zh/ref/faq/">FAQ</a></li><li class="menu__list-item"><a class="menu__link" to="https://github.com/nervosnetwork/muta/blob/master/CONTRIBUTING.md/" target="_blank" rel="noreferrer noopener" href="https://github.com/nervosnetwork/muta/blob/master/CONTRIBUTING.md/">Contributing</a></li></ul></li></ul></div></div></div><main class="main_2vyu"><div><div class="container_2j_u"><div class="leftCol_3JzO"><div class="docItemContainer_"><article><header><div class="badges"></div><h1 class="docTitle_cWlf">Mempool</h1></header><div class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="设计要求"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#设计要求" title="Direct link to heading">#</a>设计要求</h2><p>Mempool 是节点负责收集新交易以及打包新交易给共识模块进行共识的功能模块。很自然地，我们对 Mempool 会提出一些要求：</p><ol><li>性能优秀，在普通计算设备中运行即可达到每秒插入 10000+ 笔交易的性能要求。</li><li>公平性，按照收到交易的顺序打包交易。</li></ol><p>此外，为了配合共识过程与交易同步过程并发的设计，还有第三个要求：</p><ol start="3"><li>打包给共识的交易包含两部分：用于共识的 order 交易以及用于同步的 propose 交易。</li></ol><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="设计方案"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#设计方案" title="Direct link to heading">#</a>设计方案</h2><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="优良性能"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#优良性能" title="Direct link to heading">#</a>优良性能</h3><p>要获得优秀的性能，首先要分析交易插入的过程，找到性能瓶颈之处对症解决。一笔交易插入 Mempool 的过程包括：</p><ol><li>检查交易池是否已满，以避免内存溢出。</li><li>检查交易是否已经被交易池包含，以避免重复插入。</li><li>检查交易的签名是否正确，格式是否合规，以避免插入明显错误的交易。</li><li>检查交易是否已经上链，以避免共识已上链的交易。</li></ol><p>随着区块链的不断增长，历史交易数据日益庞大，步骤 4 的查询将会成为性能黑洞。我们通过在交易中设置一个必填的 timeout 字段，以及一个全局约束参数 g 来解决该问题。</p><p>具体来说，当某笔交易的 timeout 为 t，若该交易在高度 t 仍未被打包，则会被视为失效而被节点抛弃。为了避免用户设置过高的 timeout，若最新高度为 h 的节点收到的交易的 timeout t &gt; h + g，同样会被节点视为非法而抛弃。在这种机制的约束下，最新高度为 h 的节点仅需保存高度区间为 [h - g, h] 的历史交易用于查重，查重的计算复杂度和存储复杂度均降到了O(g)，与历史交易总量无关。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="公平打包"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#公平打包" title="Direct link to heading">#</a>公平打包</h3><p>在交易优先级相同的情况下，如果节点后收到的交易却先被打包，这显然有违公平性。因此，交易池的交易必须按照先入先出的原则进行打包。</p><p>然而，如果按照以太坊的 nonce 单调递增的设计（交易中的 nonce 字段的设计是为了确保交易的唯一性），若交易池同时包含多笔同一用户发出的交易，则这些交易之间还需要满足偏序关系，这会给打包机制带来非常大的复杂性。因此，我们采用随机 nonce 的方式生成唯一交易，这种设计还会带来其他一些额外的好处，比如获得了更好的并发执行能力（例如同一个用户发出的多笔交易被同一个区块打包，在以太坊中这些交易必须顺序执行，而采用随机 nonce 后，我们就可以并发执行这些交易），简化钱包的设计（在以太坊中，钱包需要同步最新的 nonce，以避免发出重复的交易，而在我们的设计中就没有这样的要求）。</p><p>总之，强制要求一个用户的所有交易保持偏序是没有必要且低效的，如果某些交易之间存在某种依赖关系，我们可以使用 ref 字段来表示这种关系，以此获得比以太坊更通用的依赖表达，比如用于表示不同用户之间交易的依赖关系。并且我们的顺序打包方案可以很容易地扩展到满足这种依赖需求。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor" id="提前同步"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#提前同步" title="Direct link to heading">#</a>提前同步</h3><p>由于区块链是一个分布式系统，不同节点的交易池所包含的交易集合不会完全相同。共识过程与交易同步打包的核心思想是，在交易池中包含的交易很多，无法被一次共识完成的情况下（受限于 cycle_limit，类似以太坊的 gas_limit），未参与共识的交易的同步过程可以与共识过程并发进行。通过这样的设计，在下一个高度的共识开始的时候，参与共识的交易的同步过程已经提前一个高度开始了，共识效率因此得到了提升。</p><p>具体来说，就是交易池打包的时候，在 order 交易满了之后，继续打包交易作为 propose 交易。在共识的时候，leader 节点发出的提案中包含了 order 交易 和 propose 交易（提案中包含的实际上都是交易哈希，在共识过程中，我们采用的是 compact block<sup id="fnref-1"><a href="#fn-1" class="footnote-ref">1</a></sup> 的设计）。order 交易参与共识，而 propose 交易开始同步。</p><h2><a aria-hidden="true" tabindex="-1" class="anchor" id="具体设计"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#具体设计" title="Direct link to heading">#</a>具体设计</h2><p>为了满足以上要求，我们用 Map 和 Queue 结构共享存储交易数据，Map 可快速查询和删除，而 Queue 满足先入先出的打包要求。事实上，我们用了两个 queue，就像两个杯子交替倒牛奶。Mempool 的核心数据结构如下：</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_3RXF"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1PCb">Copy</button><pre class="prism-code language-rust codeBlock_1wn8"><div class="codeBlockLines_3HrO" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> TxCache </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// 用 queue 实现先入先出的打包功能. </span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// 用两个 queue 轮流存储交易. 一个 queue 当前轮值, 另一个则作为替补. </span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// 打包时从当前轮值的 queue 中顺序打包.</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    queue_0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Queue</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">SharedTx</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    queue_1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Queue</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">SharedTx</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// 用 map 完成高效的随机查询和删除交易.</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    map</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Map</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Hash</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> SharedTx</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// 指示当前轮值的 queue, true 为 queue_0, false 为 queue_1.</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    is_zero</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> AtomicBool</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// 用于原子操作，以妥善处理打包与插入的并发问题. </span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    concurrent_count</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> AtomicUsize</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/// 用于 map 和 queue 中共享的交易结构</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> SharedTx </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Arc</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">TxWrapper</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> TxWrapper </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    tx</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> SignedTransaction</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// 该交易是否被 map 删除，有该标识的交易在打包交易时会被跳过，并且从 queue 中删除</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    removed</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> AtomicBool</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/// 避免重复同步的标识，有该标识的交易在打包 propose 交易时会被跳过</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    proposed</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> AtomicBool</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/// 用于存储共识同步返回的交易</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> CallbackCache </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Map</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Hash</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> SignedTransaction</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/// Mempool 打包返回给共识模块的数据结构</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> MixedTxHashes </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    order_tx_hashes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Vec</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Hash</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain">    propose_tx_hashes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Vec</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">Hash</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></div><div class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></div></div></pre></div></div><p>通过所有检查的新交易在插入 Mempool 时，首先包装为 <code>TxWrapper</code>（<code>removed</code> 和 <code>proposed</code> 均设置为 <code>false</code>）。然后转换为 <code>SharedTx</code> 并插入 <code>TxCache</code> 中（插入当前轮值的 <code>queue</code> 的尾部，以及 <code>map</code> 中）。 </p><p>Mempool 收到共识的打包请求时，返回 <code>MixedTxHashes</code>，其中包含用于共识的 <code>order_tx_hashes</code> 和用于提前同步的 <code>propose_tx_hashes</code>。</p><p>打包算法如下，从当前轮值的 <code>queue</code> 的头部开始弹出交易，跳过 <code>removed = true</code> 的 <code>TxWrapper</code>，直到达到 <code>cycle_limit </code>上限为止，将这些交易哈希插入 <code>order_tx_hashes</code> 中。继续弹出交易，跳过 <code>proposed = true</code> 的 <code>TxWrapper</code>，直到达到 <code>cycle_limit</code> 上限为止，将这些交易哈希插入 <code>propose_tx_hashes</code> 中。以上弹出的交易除了 <code>removed = true</code> 的交易外都按照弹出顺序插入到当前替补的 <code>queue</code> 中。当轮值 <code>queue</code> 全部弹出后，交换两个 <code>queue</code> 的身份。</p><p>当节点收到来自 leader 的 proposal 时，会请求 Mempool 检查 <code>order_tx_hashes</code> 和 <code>propose_tx_hashes</code>。Mempool 通过查询 <code>TxCache.map</code> 确定交易是否存在，对于缺失的交易发起同步请求。对于同步返回的 order 交易插入到 <code>CallbackCache</code> 中，而对于同步返回的 propose 交易则插入到 <code>TxCache</code>  中，并将 <code>proposed</code> 设置为 <code>true</code>。</p><p>Mempool 收到共识的删除指定 <code>tx_hashes</code> 集合的请求时，先清空 <code>CallbackCache</code>，然后查询 <code>TxCache.map</code>，将对应的 <code>TxWrapper</code> 中的 <code>removed</code> 设置为 <code>true</code>，然后删除该 <code>SharedTx</code>。</p><p>Mempool 的插入和打包过程如下图所示。</p><p><img src="./static/mempool_process.png" alt="image"></p><p><sup id="fnref-1"><a href="#fn-1" class="footnote-ref">1</a></sup> compact block: 压缩区块，leader 发送的 proposal 中仅包含交易哈希，收到 proposal 的节点检查交易哈希是否在本地 Mempool 中，如果没有则向 leader 请求缺失的完整交易。通过 compact block 的设计，可以减少交易传输量，提高带宽利用率。</p></div></article></div><div class="paginator_3VDt"><nav class="pagination-nav"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/new-docs/docs/docs_zh/advanced/core/network"><h5 class="pagination-nav__link--sublabel">Previous</h5><h4 class="pagination-nav__link--label">« Network</h4></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/new-docs/docs/docs_zh/advanced/core/storage"><h5 class="pagination-nav__link--sublabel">Next</h5><h4 class="pagination-nav__link--label">Storage »</h4></a></div></nav></div></div><div class="rightCol_38kP"><div class="table-of-contents tableOfContents_tVyB"><div class="section"><div class="title">Contents</div><ul class="contents"><li><a href="#设计要求" class="contents__link">设计要求</a></li><li><a href="#设计方案" class="contents__link">设计方案</a><ul><li><a href="#优良性能" class="contents__link">优良性能</a></li><li><a href="#公平打包" class="contents__link">公平打包</a></li><li><a href="#提前同步" class="contents__link">提前同步</a></li></ul></li><li><a href="#具体设计" class="contents__link">具体设计</a></li></ul></div><div class="section"><div class="title">Resources</div><ul class="contents"><li><a href="https://github.com/nervosnetwork/muta/edit/master/website/docs/docs_zh/advanced/core/mempool.md" class="contents__link" target="_blank"><i class="feather icon-edit-1"></i> Edit this page</a></li></ul></div></div></div></div></div></main></div></div><footer class="footer"><div class="container"><div class="row footer__links"><div class="col col--5 footer__col"><div class="margin-bottom--md"></div><div class="margin-bottom--md"><div class="mailing-list"><form action="https://dev.us17.list-manage.com/subscribe/post?u=a7b19925733ee6bf88e045485&amp;id=d8c4724e17" method="post" class="mailing-list--form"><button class="button button--primary button--undefined" type="submit">❤ Subscribe us for Muta updates ❤ </button></form></div></div><div><a href="https://twitter.com/nervosnetwork" target="_blank"><i class="feather icon-twitter" alt="Vector&#x27;s Twitter"></i></a>    <a href="https://discord.com/invite/rN35fe8" target="_blank"><i class="feather icon-message-circle" alt="Vector&#x27;s Chat"></i></a>    <a href="https://github.com/nervosnetwork/muta" target="_blank"><i class="feather icon-github" alt="Vector&#x27;s Github Repo"></i></a></div></div><div class="col footer__col"><h4 class="footer__title">About</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/new-docs/docs/about/what-is-muta/">What is Muta?</a></li><li class="footer__item"><a class="footer__link-item" href="/new-docs/community/#team">The Team</a></li><li class="footer__item"><a class="footer__link-item" href="/new-docs/contact/">Contact Us</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Development</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/new-docs/docs/setup/getting-started/">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/new-docs/docs/dev/dev-overview/">Service Dev</a></li><li class="footer__item"><a class="footer__link-item" href="/new-docs/docs/dev/dex/">Dapp Dev</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" target="_blank" rel="noopener noreferrer" href="https://talk.nervos.org/">Forum</a></li><li class="footer__item"><a class="footer__link-item" target="_blank" rel="noopener noreferrer" href="https://discord.com/invite/rN35fe8">Discord</a></li><li class="footer__item"><a class="footer__link-item" target="_blank" rel="noopener noreferrer" href="https://twitter.com/nervosnetwork">Twitter</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/new-docs/blog">Blog</a></li><li class="footer__item"><a class="footer__link-item" target="_blank" rel="noopener noreferrer" href="https://github.com/nervosnetwork/muta">GitHub</a></li></ul></div></div><div class="text--center"><div class="margin-bottom--sm"><a href="https://nervos.org/" target="_blank" rel="noopener noreferrer" class="footerLogoLink_3L_r"></a></div>Copyright © 2020 Nervos Fundation<br></div></div></footer>
</div>

<script src="/new-docs/styles.a0bcde56.js"></script>

<script src="/new-docs/runtime~main.c72716e7.js"></script>

<script src="/new-docs/main.ed56201c.js"></script>

<script src="/new-docs/1.e4da9918.js"></script>

<script src="/new-docs/2.b26b4069.js"></script>

<script src="/new-docs/3.045d625b.js"></script>

<script src="/new-docs/1be78505.5b0e4c14.js"></script>

<script src="/new-docs/46ce4c7b.572e61af.js"></script>

<script src="/new-docs/5.bc0d6714.js"></script>

<script src="/new-docs/17896441.c7f410fa.js"></script>

<script src="/new-docs/d8bb8ba4.f49ee4c4.js"></script>


</body>
</html>